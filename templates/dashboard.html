<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Assistant Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #1f2937; background: #f6f8fa; }
    .layout-root { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; padding: 30px 22px 0 24px; background: #21293a; color: #dbeafe; border-right: 1.5px solid #e5e7eb; }
    .sidebar h2 { color: #60a5fa; font-size: 19px; margin-bottom: 16px; }
    .sidebar ul { margin: 0; padding: 0; list-style: none; }
    .sidebar .nav-section { font-size: 13px; color: #9ca3af; text-transform: uppercase; margin-top: 40px; }
    .sidebar .coming-soon { font-size: 12.5px; color: #94a3b8; margin-top: 30px; }
    .main { flex: 1; padding: 36px 44px 24px 44px; min-width: 0; }
    .title-row { display: flex; align-items: flex-baseline; gap: 20px; }
    h1 { font-size: 26px; margin: 0; font-weight: 700; color: #292524; }
    .subtitle { color: #64748b; font-size: 15.2px; margin: 6px 0 20px 0; }
    .statsbar { margin-top: 18px; margin-bottom: 24px; display: flex; gap: 32px; padding: 0 5px; }
    .stat { display: flex; flex-direction: column; align-items: flex-start; background: #fff; border-radius: 9px; padding: 18px 27px 14px 18px; box-shadow: 0 1.5px 8px 0 #1111; }
    .stat-label { color: #64748b; font-size: 13px; letter-spacing: .06em; margin-bottom: 5px; }
    .stat-value { color: #111827; font-size: 23px; font-weight: 600; }
    
    .filter-bar {
      display: flex;
      gap: 14px;
      align-items: center;
      background: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 1px 5px #0001;
      margin-bottom: 20px;
    }
    .filter-bar select, .filter-bar button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
    }
    .filter-bar button {
      background: #2563eb;
      color: #fff;
      cursor: pointer;
    }
    .filter-bar button:hover { background: #1e40af; }

    .email-data-card { margin-top: 36px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px 0 #1112; }
    th, td { text-align: left; padding: 9px 10px; border-bottom: 1px solid #e5e7eb; }
    th { background: #f3f7fb; font-weight: 600; color: #374151; font-size: 15px; }
    tr:last-child td { border-bottom: 0; }
    td.summary { color: #374151; max-width: 425px; }
    .tag { display: inline-block; padding: 2.5px 9px; border-radius: 999px; font-size: 12.7px; font-weight: 620; border: 1px solid transparent; }
    .tag-student { background: #dbeafe; color: #1e3a8a; border-color: #bfdbfe; }
    .tag-faculty { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .tag-vendor { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .tag-researcher { background: #fef3c7; color: #92400e; border-color: #fde68a; }
    .tag-admin { background: #f3e8ff; color: #6b21a8; border-color: #e9d5ff; }
    .tag-default { background: #e5e7eb; color: #374151; border-color: #d1d5db; }
  </style>
</head>

<body>
  <div class="layout-root">
    <aside class="sidebar">
      <h2>Email Assistant</h2>
      <div class="nav-section">NAVIGATION <span style="font-size:11px; color:#64748b;"></span></div>
      <ul>
        <li style="color:#bae6fd; margin: 19px 0 7px 0; font-weight:560;">Dashboard</li>
      </ul>
    </aside>

    <main class="main">
      <div class="title-row">
        <h1>Email Assistant Dashboard</h1>
      </div>
      <div class="subtitle">Monitor, organize, and analyze your multi-source institutional email conversations.</div>

      <div class="statsbar">
        <div class="stat"><span class="stat-label">Unique Contacts</span><span class="stat-value" id="contact-count">{{ unique_contacts }}</span></div>
        <div class="stat"><span class="stat-label">Total Summaries</span><span class="stat-value" id="summary-count">{{ summary_count }}</span></div>
      </div>

      <!-- ðŸ”½ Filter bar -->
      <div class="filter-bar">
        <label for="roleFilter">Role:</label>
        <select id="roleFilter">
          <option value="">All Roles</option>
          <option value="Student">Student</option>
          <option value="Faculty">Faculty</option>
          <option value="Vendor">Vendor</option>
          <option value="Researcher">Researcher</option>
          <option value="Admin">Admin</option>
          <option value="Uncategorized">Uncategorized</option>
        </select>

        <label for="importanceFilter">Importance:</label>
        <select id="importanceFilter">
          <option value="">All</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>

        <button onclick="clearFilters()">Clear Filters</button>
      </div>

      <div class="email-data-card">
        <table>
          <thead>
            <tr>
              <th>Id</th>
              <th>Email</th>
              <th>Role</th>
              <th>Summary</th>
              <th>Date</th>
              <th>Source</th>
            </tr>
          </thead>
          <tbody id="rows-tbody">
            {% for it in items %}
            <tr data-role="{{ it.role }}" data-importance="{{ it.importance|default('Medium') }}">
              <td>{{ it.id }}</td>
              <td>{{ it.email }}</td>
              <td><span class="tag {{ it.role_class }}">{{ it.role }}</span></td>
              <td class="summary">{{ it.summary }}</td>
              <td>{{ it.date }}</td>
              <td>{{ it.source }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    function escapeHTML(s) {
      return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function toPKT(dateStr) {
      if (!dateStr) return '';
      try {
        let asISO = dateStr.match(/Z|[+-]\d{2}:?\d{2}$/) ? dateStr : dateStr + 'Z';
        let d = new Date(asISO);
        let utc = d.getTime() + d.getTimezoneOffset() * 60000;
        let pkt = new Date(utc + 5 * 60 * 60 * 1000);
        let yr = pkt.getUTCFullYear();
        let mo = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][pkt.getUTCMonth()];
        let day = pkt.getUTCDate().toString().padStart(2,'0');
        let h24 = pkt.getUTCHours();
        let mn = pkt.getUTCMinutes().toString().padStart(2,'0');
        let ampm = h24 >= 12 ? 'PM' : 'AM';
        let h12 = h24 % 12; if (h12 === 0) h12 = 12;
        let hr = h12.toString().padStart(2, '0');
        return `${day} ${mo} ${yr}, ${hr}:${mn} ${ampm} (PKT)`;
      } catch {
        return escapeHTML(dateStr);
      }
    }

    function makeRow(it) {
      return `<tr data-role="${it.role || ''}" data-importance="${it.importance || 'Medium'}">
        <td>${escapeHTML(it.id || '')}</td>
        <td>${escapeHTML(it.email || '')}</td>
        <td><span class="tag ${it.role_class || 'tag-default'}">${escapeHTML(it.role || '')}</span></td>
        <td class="summary">${escapeHTML(it.summary || '')}</td>
        <td>${toPKT(it.date || '')}</td>
        <td>${escapeHTML(it.source || '')}</td>
      </tr>`;
    }

    async function updateTable() {
      const resp = await fetch('/api/summaries');
      if (!resp.ok) return;
      const data = await resp.json();
      const rows = data.items || [];
      document.getElementById('rows-tbody').innerHTML = rows.map(makeRow).join('');
      document.getElementById('contact-count').textContent = rows.length;
      document.getElementById('summary-count').textContent = (data.count || rows.length);
    }

    function applyFilters() {
      const role = document.getElementById('roleFilter').value;
      const importance = document.getElementById('importanceFilter').value;
      const rows = document.querySelectorAll('#rows-tbody tr');
      rows.forEach(r => {
        const matchesRole = !role || r.dataset.role === role;
        const matchesImportance = !importance || r.dataset.importance === importance;
        r.style.display = (matchesRole && matchesImportance) ? '' : 'none';
      });
    }

    function clearFilters() {
      document.getElementById('roleFilter').value = '';
      document.getElementById('importanceFilter').value = '';
      applyFilters();
    }

    document.getElementById('roleFilter').addEventListener('change', applyFilters);
    document.getElementById('importanceFilter').addEventListener('change', applyFilters);

    setInterval(updateTable, 60000);
    window.addEventListener('DOMContentLoaded', updateTable);
  </script>
</body>
</html>
