<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email Assistant Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #1f2937; background: #f6f8fa; }
    .layout-root { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; padding: 30px 22px 0 24px; background: #21293a; color: #dbeafe; border-right: 1.5px solid #e5e7eb; }
    .sidebar h2 { color: #60a5fa; font-size: 19px; margin-bottom: 16px; }
    .sidebar ul { margin: 0; padding: 0; list-style: none; }
    .sidebar .nav-section { font-size: 13px; color: #9ca3af; text-transform: uppercase; margin-top: 40px; }
    .sidebar .coming-soon { font-size: 12.5px; color: #94a3b8; margin-top: 30px; }
    .main { flex: 1; padding: 36px 44px 24px 44px; min-width: 0; }
    .title-row { display: flex; align-items: flex-baseline; gap: 20px; }
    h1 { font-size: 26px; margin: 0; font-weight: 700; color: #292524; }
    .subtitle { color: #64748b; font-size: 15.2px; margin: 6px 0 20px 0; }
    .statsbar { margin-top: 18px; margin-bottom: 24px; display: flex; gap: 32px; padding: 0 5px; }
    .stat { display: flex; flex-direction: column; align-items: flex-start; background: #fff; border-radius: 9px; padding: 18px 27px 14px 18px; box-shadow: 0 1.5px 8px 0 #1111; }
    .stat-label { color: #64748b; font-size: 13px; letter-spacing: .06em; margin-bottom: 5px; }
    .stat-value { color: #111827; font-size: 23px; font-weight: 600; }
    
    .email-data-card { margin-top: 36px; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px 0 #1112; }
    th, td { text-align: left; padding: 9px 10px; border-bottom: 1px solid #e5e7eb; }
    th { background: #f3f7fb; font-weight: 600; color: #374151; font-size: 15px; }
    tr:last-child td { border-bottom: 0; }
    td.summary { color: #374151; max-width: 425px; }
    .tag { display: inline-block; padding: 2.5px 9px; border-radius: 999px; font-size: 12.7px; font-weight: 620; border: 1px solid transparent; }
    .tag-student { background: #dbeafe; color: #1e3a8a; border-color: #bfdbfe; }
    .tag-faculty { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .tag-vendor { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .tag-default { background: #e5e7eb; color: #374151; border-color: #d1d5db; }
  </style>
  <script>
    async function exportToSheets() {
      const btn = document.getElementById('exportBtn');
      btn.disabled = true;
      try {
        const res = await fetch('/export-to-sheets', { method: 'POST' });
        const data = await res.json();
        alert(data.ok ? `Exported ${data.count} rows to Google Sheets.` : `Export failed: ${data.error}`);
      } catch (e) {
        alert('Export failed.');
      } finally {
        btn.disabled = false;
      }
    }
  </script>
  </head>
  <body>
    <div class="layout-root">
      <aside class="sidebar">
        <h2>Email Assistant</h2>
        <div class="nav-section">NAVIGATION <span style="font-size:11px; color:#64748b;">(future)</span></div>
        <ul>
          <li style="color:#bae6fd; margin: 19px 0 7px 0; font-weight:560;">Dashboard</li>
          <!-- TODO: Add role-based filter/sort links here -->
          <li class="coming-soon">Filters, Roles, Analytics (soon)</li>
        </ul>
        <div class="coming-soon" style="margin-top:44px;">More features coming soon...</div>
      </aside>
      <main class="main">
        <div class="title-row">
          <h1>Email Assistant Dashboard</h1>
        </div>
        <div class="subtitle">Monitor, organize, and analyze your multi-source institutional email conversations.</div>
        <div class="statsbar">
          <div class="stat"><span class="stat-label">Unique Contacts</span><span class="stat-value" id="contact-count">{{ unique_contacts }}</span></div>
          <div class="stat"><span class="stat-label">Total Summaries</span><span class="stat-value" id="summary-count">{{ summary_count }}</span></div>
          <!-- Add more stats as needed in the future -->
        </div>
        <div class="email-data-card">
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Role</th>
              <th>Summary</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="rows-tbody">
            {% for it in items %}
            <tr>
              <td>{{ it.email }}</td>
              <td><span class="tag {{ it.role_class }}">{{ it.role }}</span></td>
              <td class="summary">{{ it.summary }}</td>
              <td>{{ it.date }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      </main>
    </div>
    <script>
      function escapeHTML(s) {
        return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
      }

      function toPKT(dateStr) {
        if (!dateStr) return '';
        try {
          let asISO = dateStr.match(/Z|[+-]\d{2}:?\d{2}$/) ? dateStr : dateStr + 'Z';
          let d = new Date(asISO);
          let utc = d.getTime() + d.getTimezoneOffset() * 60000;
          let pkt = new Date(utc + 5 * 60 * 60 * 1000);
          let yr = pkt.getUTCFullYear();
          let mo = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][pkt.getUTCMonth()];
          let day = pkt.getUTCDate().toString().padStart(2,'0');
          let h24 = pkt.getUTCHours();
          let mn = pkt.getUTCMinutes().toString().padStart(2,'0');
          let ampm = h24 >= 12 ? 'PM' : 'AM';
          let h12 = h24 % 12 || 12;
          let hr = h12.toString().padStart(2, '0');
          return `${day} ${mo} ${yr}, ${hr}:${mn} ${ampm} (PKT)`;
        } catch {
          return escapeHTML(dateStr);
        }
      }

      function makeRow(it) {
        const roleClass = it.role_class || (
          it.role === "Student" ? "tag-student" :
          it.role === "Faculty" ? "tag-faculty" :
          it.role === "Vendor" ? "tag-vendor" : "tag-default"
        );

        return `<tr>
          <td>${escapeHTML(it.email || '')}</td>
          <td><span class="tag ${roleClass}">${escapeHTML(it.role || '')}</span></td>
          <td class="summary">${escapeHTML(it.summary || '')}</td>
          <td>${toPKT(it.date || '')}</td>
        </tr>`;
      }

      async function updateTable() {
        const tbody = document.getElementById('rows-tbody');
        const contactCount = document.getElementById('contact-count');
        const summaryCount = document.getElementById('summary-count');
        const refreshStatus = document.getElementById('refresh-status');

        try {
          refreshStatus.textContent = "⟳ Refreshing...";
          const resp = await fetch('/api/summaries');
          if (!resp.ok) throw new Error("Failed to fetch summaries");

          const data = await resp.json();
          const rows = Array.isArray(data) ? data : data.items || [];

          tbody.innerHTML = rows.map(makeRow).join('');
          contactCount.textContent = rows.length;
          summaryCount.textContent = rows.length;

          const now = new Date().toLocaleTimeString();
          refreshStatus.textContent = `✅ Updated ${now}`;
        } catch (err) {
          console.error(err);
          refreshStatus.textContent = "⚠️ Failed to refresh";
        }
      }

      // Auto-refresh every 60 seconds
      setInterval(updateTable, 60000);

      // Initial load
      window.addEventListener('DOMContentLoaded', updateTable);
    </script>

    <!-- Add a small “last updated” indicator -->
    <p id="refresh-status" style="font-size:13px; color:#6b7280; margin-top:10px;">
      Loading latest summaries...
    </p>

  </body>
  </html>


